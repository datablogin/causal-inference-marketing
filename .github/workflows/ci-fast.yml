name: Fast CI Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # Run unit tests first (fast failure)
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]  # All versions with fast parameters

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          if [[ "${{ matrix.python-version }}" == "3.13" ]]; then
            # Skip ML dependencies for Python 3.13 due to compilation issues
            uv sync --frozen --extra dev --extra test
          else
            uv sync --frozen --extra dev --extra test --extra ml
          fi
        env:
          FAST_TEST_MODE: true

      - name: Run unit tests only (exclude slow/integration)
        run: uv run pytest libs/causal_inference/tests/unit/ -m "not slow and not integration" --maxfail=3 -x --tb=short
        env:
          FAST_TEST_MODE: true

  # Run integration tests in parallel (after unit tests pass)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run integration tests with fast parameters
        run: uv run pytest libs/causal_inference/tests/integration/ -m "integration" --maxfail=3 -x --tb=short

  # Run slow tests last (only if everything else passes)
  slow-tests:
    name: Slow Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    timeout-minutes: 20
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'run-slow-tests')

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run slow tests with reduced parameters
        run: uv run pytest libs/causal_inference/tests/ -m "slow" --maxfail=3 -x --tb=short
